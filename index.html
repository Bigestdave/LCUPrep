<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LCU Prep - First Class Solutions</title>
    
    <!-- 1. STYLES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 2. LIBRARIES -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0F172A', text: '#334155', sub: '#64748B',
                            blue: '#2563EB', pink: '#EC4899', surface: '#F8FAFC',
                            border: '#E2E8F0', input: '#F1F5F9',
                        }
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #FFFFFF; color: #334155; -webkit-font-smoothing: antialiased; }
        .app-bg { background-color: #F8FAFC; min-height: 100vh; }
        .hide { display: none !important; }
        .view-section { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-line { position: absolute; left: 11px; top: 24px; bottom: -24px; width: 2px; background-color: #E2E8F0; }
        .last-step .step-line { display: none; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col text-sm antialiased selection:bg-brand-blue/20 selection:text-brand-blue">

    <!-- Top Navigation -->
    <header id="top-nav" class="bg-white/90 backdrop-blur-md sticky top-0 z-40 transition-all duration-300">
        <div class="max-w-md mx-auto px-6 h-16 flex justify-between items-center">
            <div id="nav-brand" class="font-bold text-xl tracking-tight text-brand-dark flex items-center gap-2">
                <div class="w-8 h-8 bg-brand-blue text-white rounded-xl flex items-center justify-center text-sm font-bold shadow-lg shadow-blue-500/20">L</div>
                LCU Prep
            </div>
            <div id="nav-actions">
                <!-- Injected via JS -->
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-grow overflow-y-auto pb-32 max-w-md mx-auto w-full relative">
        
        <!-- VIEW: LANDING PAGE -->
        <section id="view-landing" class="view-section bg-white">
            <div class="pt-10 pb-8 px-8 text-center">
                <div class="inline-flex items-center gap-2 bg-blue-50 text-brand-blue px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider mb-6">
                    <span class="w-2 h-2 rounded-full bg-brand-blue"></span> The Smartest Way to Study
                </div>
                <h1 class="text-4xl font-extrabold mb-6 leading-[1.1] text-brand-dark">
                    <span class="text-brand-blue">4 out of 15</span> Tutorial <br>Questions <br>will appear in your <br>exam.
                </h1>
                <p class="text-brand-sub text-base mb-10 leading-relaxed max-w-xs mx-auto font-medium">
                    We provide <strong class="text-brand-dark">First Class level solutions</strong> to all 15 tutorial questions. Study the right things.
                </p>
                <div class="space-y-3">
                    <button onclick="app.navigateTo('signup')" class="bg-brand-blue text-white font-bold py-4 px-8 rounded-2xl shadow-lg shadow-blue-500/25 hover:scale-[1.02] transition w-full text-base">Find My Course</button>
                    <button onclick="app.navigateTo('login')" class="text-brand-sub font-semibold py-4 px-6 w-full hover:bg-slate-50 rounded-2xl transition border border-slate-100">I already have an account</button>
                </div>
            </div>
            
            <!-- Value Cards -->
            <div class="px-6 py-4 bg-white pb-20">
                <div class="space-y-4">
                    <div class="bg-white p-8 rounded-3xl shadow-card text-center border border-slate-100">
                        <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-dark text-lg shadow-sm"><i class="fa-solid fa-book-open"></i></div>
                        <h3 class="font-bold text-brand-dark mb-1 text-lg">All 15 Solved</h3>
                        <p class="text-brand-sub text-xs font-medium">Complete solutions to every tutorial question</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-card text-center border border-slate-100">
                        <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-dark text-lg shadow-sm"><i class="fa-solid fa-bullseye"></i></div>
                        <h3 class="font-bold text-brand-dark mb-1 text-lg">100% Coverage</h3>
                        <p class="text-brand-sub text-xs font-medium">No matter which 4 appear, you're ready</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-card text-center border border-slate-100">
                        <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-dark text-lg shadow-sm"><i class="fa-solid fa-award"></i></div>
                        <h3 class="font-bold text-brand-dark mb-1 text-lg">First Class Answers</h3>
                        <p class="text-brand-sub text-xs font-medium">Detailed workings that impress lecturers</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: AUTH -->
        <section id="view-signup" class="view-section hide px-6 py-8 bg-white min-h-screen">
            <button onclick="app.navigateTo('landing')" class="mb-6 text-brand-sub hover:text-brand-dark"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h2 class="text-3xl font-bold text-brand-dark mb-2">Create Account</h2>
            <p class="text-brand-sub mb-8 text-base">Join your course mates on LCU Prep.</p>
            <form id="signup-form" onsubmit="app.handleSignup(event)" class="space-y-5">
                <input type="text" id="signup-name" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium placeholder-slate-400" placeholder="Full Name">
                <input type="email" id="signup-email" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium placeholder-slate-400" placeholder="Email">
                <input type="password" id="signup-password" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium placeholder-slate-400" placeholder="Password (Min 6 chars)">
                
                <div class="grid grid-cols-2 gap-4">
                    <select id="signup-faculty" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium text-brand-dark">
                        <option value="Engineering">Engineering</option>
                        <option value="Sciences">Sciences</option>
                        <option value="Business">Business</option>
                        <option value="Law">Law</option>
                    </select>
                    <select id="signup-level" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium text-brand-dark">
                        <option value="100L">100L</option>
                        <option value="200L">200L</option>
                        <option value="300L">300L</option>
                        <option value="400L">400L</option>
                    </select>
                </div>
                
                <button type="submit" id="btn-signup" class="w-full bg-brand-blue text-white font-bold py-4 rounded-2xl mt-4 shadow-lg flex justify-center items-center">
                    Create Account
                </button>
                <div id="signup-error" class="text-red-500 text-xs text-center font-bold"></div>
            </form>
        </section>

        <section id="view-login" class="view-section hide px-6 py-8 bg-white min-h-screen">
            <button onclick="app.navigateTo('landing')" class="mb-6 text-brand-sub hover:text-brand-dark"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
            <h2 class="text-3xl font-bold text-brand-dark mb-2">Welcome back</h2>
            <form onsubmit="app.handleLogin(event)" class="space-y-5">
                <input type="email" id="login-email" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium placeholder-slate-400" placeholder="Email">
                <input type="password" id="login-password" required class="w-full bg-brand-input border-0 p-4 rounded-2xl font-medium placeholder-slate-400" placeholder="Password">
                <button type="submit" id="btn-login" class="w-full bg-brand-dark text-white font-bold py-4 rounded-2xl mt-4 shadow-lg flex justify-center items-center">
                    Log In
                </button>
                <div id="login-error" class="text-red-500 text-xs text-center font-bold"></div>
            </form>
        </section>

        <!-- VIEW: DASHBOARD -->
        <section id="view-dashboard" class="view-section hide pt-4 app-bg">
            <div class="px-6 pb-6 pt-2 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-brand-dark tracking-tight">Hi, <span id="dash-username">Student</span> ðŸ‘‹</h1>
                    <p class="text-brand-sub text-xs font-medium mt-1" id="dash-filter-label">Loading...</p>
                </div>
                <div onclick="app.navigateTo('profile')" class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white shadow-sm flex items-center justify-center cursor-pointer"><i class="fa-solid fa-user text-slate-400"></i></div>
            </div>
            
            <div class="px-6 mb-8">
                <div class="relative group">
                    <i class="fa-solid fa-search absolute left-5 top-4 text-slate-400 text-sm"></i>
                    <input type="text" id="search-input" onkeyup="app.filterCourses()" placeholder="Search for MTH 201..." class="w-full pl-12 pr-6 py-4 bg-brand-input rounded-full text-sm font-medium focus:outline-none focus:bg-white transition shadow-sm">
                </div>
            </div>

            <div class="px-6 pb-8">
                <h2 class="font-bold text-lg text-brand-dark mb-4 flex items-center gap-2">Your Courses <span class="bg-blue-100 text-brand-blue text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">Priority</span></h2>
                <div id="course-grid-personal" class="space-y-4"></div>
            </div>

            <div class="px-6 pb-20">
                <h2 class="font-bold text-lg text-brand-dark mb-4">Browse Catalog</h2>
                <div class="flex gap-2 overflow-x-auto pb-4 -mx-6 px-6 no-scrollbar" id="filter-faculty-container"></div>
                <div id="course-grid-all" class="space-y-3"></div>
            </div>
        </section>

        <!-- VIEW: COURSE DETAIL -->
        <section id="view-course-detail" class="view-section hide bg-white min-h-screen">
            <div class="px-6 py-4 flex items-center justify-between sticky top-0 bg-white/95 backdrop-blur z-20 border-b border-slate-100">
                <button onclick="app.navigateTo('dashboard')" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-brand-sub hover:text-brand-dark"><i class="fa-solid fa-arrow-left"></i></button>
                <span class="font-bold text-sm text-brand-dark uppercase tracking-wider opacity-60" id="detail-code-nav">CODE</span>
                <button class="w-10 h-10"></button>
            </div>
            <div class="px-6 py-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center text-xs font-bold shadow-lg shadow-blue-500/20"><i class="fa-solid fa-graduation-cap text-lg"></i></div>
                    <div><div class="text-[11px] font-bold text-brand-blue uppercase tracking-wide bg-blue-50 inline-block px-2 py-0.5 rounded-md mb-1" id="detail-code">CODE</div><div class="text-xs text-brand-sub font-medium" id="detail-faculty">Faculty</div></div>
                </div>
                <h1 id="detail-title" class="text-3xl font-extrabold text-brand-dark leading-tight mb-6 font-serif">Title</h1>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100"><div class="text-brand-sub text-xs font-medium mb-1">Tutorials</div><div class="text-brand-dark font-bold text-lg">15 Qs</div></div>
                    <div class="bg-green-50 rounded-2xl p-4 border border-green-100"><div class="text-green-700 text-xs font-medium mb-1 flex items-center gap-1"><i class="fa-solid fa-check-circle text-[10px]"></i> Solved</div><div class="text-green-800 font-bold text-lg">15/15</div></div>
                </div>
                <div class="text-brand-sub text-sm leading-relaxed mb-8">Master this course with verified step-by-step solutions. Designed to help you understand the core concepts for exams.</div>
            </div>
            <div class="bg-slate-50 rounded-t-[2.5rem] px-6 py-8 pb-32 min-h-[50vh] shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.05)]">
                <h3 class="font-bold text-brand-dark text-lg mb-6 ml-2">Course Content</h3>
                <div id="preview-list" class="space-y-4"></div>
            </div>
            <div class="fixed bottom-6 left-6 right-6 z-30">
                <div class="max-w-md mx-auto">
                    <div id="btn-container-buy" class="bg-brand-dark text-white p-2 pl-6 rounded-[1.25rem] shadow-float flex items-center justify-between">
                        <div class="flex flex-col"><span class="text-[10px] text-slate-300 uppercase font-bold tracking-wider">Full Access</span><div class="bg-brand-blue text-white text-xs font-bold px-2 py-0.5 rounded-md inline-block self-start mt-0.5">N<span id="detail-price">300</span></div></div>
                        <button onclick="app.initiatePayment()" class="bg-white text-brand-dark font-bold py-3 px-6 rounded-xl hover:bg-slate-100 transition shadow-sm">Unlock Now</button>
                    </div>
                    <button id="btn-view-course" onclick="app.openAnswers()" class="hidden w-full bg-brand-blue text-white font-bold py-4 px-6 rounded-[1.25rem] shadow-float hover:bg-blue-600 transition flex justify-center items-center gap-2"><span>Start Learning</span> <i class="fa-solid fa-arrow-right"></i></button>
                    <div class="text-center mt-2 text-[10px] text-slate-400 font-bold flex justify-center gap-1"><i class="fa-solid fa-shield text-green-500"></i> Money-back guarantee</div>
                </div>
            </div>
        </section>

        <!-- VIEW: ANSWERS -->
        <section id="view-answers" class="view-section hide bg-white min-h-screen relative">
            <div class="sticky top-0 bg-white/95 backdrop-blur border-b border-slate-100 z-40 px-6 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button onclick="app.navigateTo('dashboard')" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-times"></i></button>
                    <h2 id="ans-code" class="font-bold text-brand-dark text-sm">CODE</h2>
                </div>
                <div class="text-[10px] font-bold text-brand-sub uppercase tracking-wider border border-slate-200 px-2 py-1 rounded">Read Mode</div>
            </div>
            <div id="full-answers-container" class="px-6 py-8 space-y-16 pb-32 relative z-20 max-w-2xl mx-auto"></div>
        </section>

        <!-- VIEW: PROFILE -->
        <section id="view-profile" class="view-section hide app-bg min-h-screen">
            <div class="px-6 py-8">
                <h1 class="text-2xl font-bold text-brand-dark mb-6">Account</h1>
                <div class="bg-white rounded-[1.5rem] shadow-card p-6 mb-8 flex items-center gap-5">
                    <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-brand-dark font-bold text-2xl border-4 border-slate-50 text-brand-blue"><span id="profile-initial">D</span></div>
                    <div><h2 id="profile-name" class="font-bold text-brand-dark text-lg">Student</h2><p id="profile-details" class="text-sm text-brand-sub mt-1 font-medium">Dept â€¢ Level</p></div>
                </div>
                <div class="bg-gradient-to-br from-brand-dark to-slate-800 text-white rounded-[1.5rem] shadow-float p-6 mb-8 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Referral Earnings</p><h3 class="text-3xl font-bold text-white">N350</h3></div>
                        <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-wallet text-white/80"></i></div>
                    </div>
                    <div class="flex gap-3"><button class="flex-1 bg-white text-brand-dark text-xs font-bold py-2.5 px-4 rounded-xl">Withdraw</button><button class="flex-1 bg-brand-blue text-white text-xs font-bold py-2.5 px-4 rounded-xl">Invite</button></div>
                </div>
                <div class="bg-white rounded-[1.5rem] shadow-card overflow-hidden">
                    <button onclick="app.navigateTo('purchases')" class="w-full text-left px-6 py-5 border-b border-slate-50 flex justify-between items-center hover:bg-slate-50"><span class="text-sm font-semibold text-brand-dark flex items-center gap-3"><i class="fa-solid fa-book-open text-brand-sub w-5"></i> My Library</span><i class="fa-solid fa-chevron-right text-xs text-slate-300"></i></button>
                    <button onclick="app.logout()" class="w-full text-left px-6 py-5 flex justify-between items-center hover:bg-red-50"><span class="text-sm font-semibold text-red-500 flex items-center gap-3"><i class="fa-solid fa-arrow-right-from-bracket text-red-400 w-5"></i> Log Out</span></button>
                </div>
            </div>
        </section>

        <!-- VIEW: LIBRARY -->
        <section id="view-purchases" class="view-section hide app-bg min-h-screen">
            <div class="px-6 py-8">
                <h1 class="text-2xl font-bold text-brand-dark mb-6">My Library</h1>
                <div id="purchases-list" class="space-y-4"></div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav id="nav-bottom" class="fixed bottom-6 left-6 right-6 max-w-md mx-auto z-40 hide transition-transform duration-300">
        <div class="bg-white/90 backdrop-blur-xl border border-white/20 shadow-float rounded-full px-6 py-3 flex justify-between items-center">
            <button onclick="app.navigateTo('dashboard')" id="nav-dash" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-brand-dark transition group"><i class="fa-solid fa-house text-xl mb-0.5 group-hover:scale-110 transition"></i></button>
            <button onclick="app.navigateTo('purchases')" id="nav-buys" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-brand-dark transition group"><i class="fa-solid fa-book-bookmark text-xl mb-0.5 group-hover:scale-110 transition"></i></button>
            <button onclick="app.navigateTo('profile')" id="nav-profile" class="flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-brand-dark transition group"><i class="fa-solid fa-user text-xl mb-0.5 group-hover:scale-110 transition"></i></button>
        </div>
    </nav>

    <!-- TOAST -->
    <div id="toast" class="fixed top-8 right-0 left-0 flex justify-center z-[70] transform -translate-y-24 transition-transform duration-500 pointer-events-none">
        <div class="bg-brand-dark text-white px-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 text-sm font-bold">
            <div class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center text-xs text-brand-dark"><i class="fa-solid fa-check"></i></div>
            <span id="toast-msg">Success</span>
        </div>
    </div>

    <!-- APP LOGIC -->
    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://ykkspgvhveaeeaisprqz.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlra3NwZ3ZodmVhZWVhaXNwcnF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTUyMTcsImV4cCI6MjA4MTQ5MTIxN30.czIFeiOXzPIT1N7rJ0zdc3uMnLykoiGAxmNWgPeA-h8';
        const PAYSTACK_KEY = 'pk_live_2320cc6bb508955bd07391f75a4c73d757a0d6f6';

        // --- 2. COURSES DB (ADD YOUR QUESTIONS HERE) ---
        const COURSES_DB = [
            { 
                id: 'mth201', code: 'MTH 201', title: 'Engineering Mathematics II', faculty: 'Engineering', level: '200L', price: 300, 
                questions: [
                    { q: 'Solve dy/dx + 2y = 4x', a: '### Step 1\nIdentify DE.\n\n### Answer\ny = 2x - 1 + Ce^-2x' },
                    { q: 'Evaluate Integral sin^2(x)', a: '### Answer\nPi/2' }
                ] 
            },
            { 
                id: 'gst111', code: 'GST 111', title: 'Use of English', faculty: 'Arts', level: '100L', price: 200, 
                questions: [{ q: 'Define Noun Phrase', a: 'A group of words.' }] 
            }
        ];

        let supabase;
        const app = {
            state: { user: null, profile: null, currentCourseId: null, purchasedIds: [] },

            // Init waits for Supabase library to load
            init: async function() {
                // If script didn't load yet, retry in 100ms
                if (typeof window.supabase === 'undefined') {
                    console.log('Waiting for Supabase...');
                    setTimeout(app.init, 100);
                    return;
                }
                
                // Initialize Supabase Client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // Check Session
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    this.state.user = session.user;
                    await this.loadUserData();
                    this.navigateTo('dashboard');
                } else {
                    this.navigateTo('landing');
                }
                this.setupFilters();
            },

            loadUserData: async function() {
                const userId = this.state.user.id;
                let { data: profile } = await supabase.from('profiles').select('*').eq('id', userId).single();
                if (!profile) {
                    const meta = this.state.user.user_metadata;
                    const { error } = await supabase.from('profiles').insert([{
                        id: userId, full_name: meta.full_name, faculty: meta.faculty, level: meta.level
                    }]);
                    if(!error) profile = { full_name: meta.full_name, faculty: meta.faculty, level: meta.level };
                }
                this.state.profile = profile;

                const { data: purchases } = await supabase.from('purchases').select('course_id').eq('user_id', userId);
                if (purchases) this.state.purchasedIds = purchases.map(p => p.course_id);
            },

            // --- AUTH ---
            handleSignup: async function(e) {
                e.preventDefault();
                const btn = document.getElementById('btn-signup');
                const err = document.getElementById('signup-error');
                btn.innerHTML = '<div class="spinner"></div>';
                err.innerText = '';

                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const name = document.getElementById('signup-name').value;
                const faculty = document.getElementById('signup-faculty').value;
                const level = document.getElementById('signup-level').value;

                const { data, error } = await supabase.auth.signUp({
                    email: email, password: password,
                    options: { data: { full_name: name, faculty: faculty, level: level } }
                });

                if (error) {
                    err.innerText = error.message;
                    btn.innerText = 'Create Account';
                    return;
                }
                
                this.state.user = data.user;
                setTimeout(async () => {
                    await this.loadUserData();
                    this.showToast('Account Created!');
                    this.navigateTo('dashboard');
                }, 1000);
            },

            handleLogin: async function(e) {
                e.preventDefault();
                const btn = document.getElementById('btn-login');
                const err = document.getElementById('login-error');
                btn.innerHTML = '<div class="spinner"></div>';
                err.innerText = '';

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: document.getElementById('login-email').value,
                    password: document.getElementById('login-password').value
                });

                if (error) {
                    err.innerText = error.message;
                    btn.innerText = 'Log In';
                    return;
                }

                this.state.user = data.user;
                await this.loadUserData();
                this.navigateTo('dashboard');
            },

            logout: async function() {
                await supabase.auth.signOut();
                this.state.user = null;
                this.state.profile = null;
                this.state.purchasedIds = [];
                this.navigateTo('landing');
            },

            // --- PAYMENTS ---
            initiatePayment: function() {
                const c = COURSES_DB.find(x => x.id === this.state.currentCourseId);
                const handler = PaystackPop.setup({
                    key: PAYSTACK_KEY,
                    email: this.state.user.email,
                    amount: c.price * 100,
                    currency: 'NGN',
                    callback: async (response) => {
                        const { error } = await supabase.from('purchases').insert([{ user_id: this.state.user.id, course_id: c.id }]);
                        if (!error) {
                            this.state.purchasedIds.push(c.id);
                            this.showToast('Payment Successful! Course Unlocked.');
                            this.openCourse(c.id);
                        } else alert("Contact support: " + error.message);
                    },
                    onClose: () => alert('Transaction cancelled.')
                });
                handler.openIframe();
            },

            // --- NAV & RENDER ---
            navigateTo: function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
                document.getElementById(`view-${viewId}`).classList.remove('hide');
                
                const top = document.getElementById('top-nav');
                const bot = document.getElementById('nav-bottom');
                const actions = document.getElementById('nav-actions');
                
                if(['landing', 'login', 'signup'].includes(viewId)) {
                    top.classList.remove('hide'); bot.classList.add('hide');
                    if(viewId === 'landing') actions.classList.remove('hide'); else actions.classList.add('hide');
                } else {
                    top.classList.add('hide'); bot.classList.remove('hide');
                    this.updateBotNav(viewId);
                }

                if(viewId === 'dashboard') this.renderDashboard();
                if(viewId === 'purchases') this.renderLibrary();
                if(viewId === 'profile') this.renderProfile();
                window.scrollTo(0,0);
            },

            updateBotNav: function(viewId) {
                ['nav-dash', 'nav-buys', 'nav-profile'].forEach(id => {
                    const el = document.getElementById(id);
                    el.className = "flex flex-col items-center gap-1 w-12 text-slate-400 hover:text-brand-dark transition group";
                });
                let active = '';
                if(viewId === 'dashboard') active = 'nav-dash';
                if(viewId === 'purchases') active = 'nav-buys';
                if(viewId === 'profile') active = 'nav-profile';
                if(active) document.getElementById(active).className = "flex flex-col items-center gap-1 w-12 text-brand-blue";
            },

            setupFilters: function() {
                const facs = ['Engineering', 'Sciences', 'Business', 'Law', 'Arts'];
                const con = document.getElementById('filter-faculty-container');
                con.innerHTML = `<button onclick="app.filterCourses('All')" class="bg-brand-dark text-white px-5 py-2.5 rounded-full text-xs font-bold whitespace-nowrap shadow-md">All</button>`;
                facs.forEach(f => {
                    con.innerHTML += `<button onclick="app.filterCourses('${f}')" class="bg-white border border-slate-200 text-brand-sub px-5 py-2.5 rounded-full text-xs font-bold whitespace-nowrap hover:bg-slate-50 transition">${f}</button>`;
                });
            },

            renderDashboard: function() {
                if(this.state.profile) {
                    const name = this.state.profile.full_name || 'Student';
                    document.getElementById('dash-username').innerText = name.split(' ')[0];
                    document.getElementById('dash-filter-label').innerText = `${this.state.profile.faculty} â€¢ ${this.state.profile.level}`;
                }
                this.filterCourses();
            },

            filterCourses: function(fac = 'All') {
                const term = document.getElementById('search-input').value.toLowerCase();
                let list = COURSES_DB.filter(c => {
                    const matchFac = fac === 'All' || c.faculty === fac;
                    const matchTerm = c.code.toLowerCase().includes(term) || c.title.toLowerCase().includes(term);
                    return matchFac && matchTerm;
                });

                const personalDiv = document.getElementById('course-grid-personal');
                const personal = list.filter(c => this.state.profile && c.faculty === this.state.profile.faculty && c.level === this.state.profile.level);
                
                if(personal.length === 0) personalDiv.innerHTML = `<div class="bg-white p-6 rounded-2xl border border-slate-100 text-center"><p class="text-brand-sub text-xs">No specific courses found for your level yet.</p></div>`;
                else personalDiv.innerHTML = personal.map(c => this.cardHtml(c, true)).join('');

                document.getElementById('course-grid-all').innerHTML = list.map(c => this.cardHtml(c, false)).join('');
            },

            cardHtml: function(c, isCard) {
                const owned = this.state.purchasedIds.includes(c.id);
                const badge = owned 
                    ? `<span class="text-[10px] font-bold text-green-600 bg-green-50 px-2.5 py-1 rounded-full border border-green-100"><i class="fa-solid fa-unlock mr-1"></i> OWNED</span>`
                    : `<span class="text-[10px] font-bold text-green-600 bg-green-50 px-2.5 py-1 rounded-full"><i class="fa-solid fa-check mr-1"></i> 15/15 Solved</span>`;
                
                if (isCard) {
                    return `
                    <div onclick="app.openCourse('${c.id}')" class="bg-white p-5 rounded-[1.5rem] border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center text-brand-blue text-lg"><i class="fa-solid fa-book"></i></div>
                            ${badge}
                        </div>
                        <h3 class="font-bold text-brand-dark text-lg leading-tight mb-1">${c.title}</h3>
                        <p class="text-brand-sub text-xs font-medium mb-4">${c.code}</p>
                        <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                            <span class="text-xs text-brand-sub font-medium">Exam Coverage: 100%</span>
                            ${!owned ? `<span class="text-brand-blue font-bold text-xs bg-blue-50 px-2 py-1 rounded-lg">N${c.price}</span>` : ''}
                        </div>
                    </div>`;
                }
                return `
                <div onclick="app.openCourse('${c.id}')" class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition shadow-sm">
                    <div class="flex items-center gap-4">
                         <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 font-bold text-xs border border-slate-100">${c.code.split(' ')[0]}</div>
                         <div><div class="font-bold text-sm text-brand-dark">${c.title}</div><div class="text-[10px] text-brand-sub font-bold uppercase mt-0.5">${c.code}</div></div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                </div>`;
            },

            openCourse: function(id) {
                this.state.currentCourseId = id;
                const c = COURSES_DB.find(x => x.id === id);
                const owned = this.state.purchasedIds.includes(id);

                document.getElementById('detail-code').innerText = c.code;
                document.getElementById('detail-code-nav').innerText = c.code;
                document.getElementById('detail-title').innerText = c.title;
                document.getElementById('detail-faculty').innerText = c.faculty;
                document.getElementById('detail-price').innerText = c.price;

                const buy = document.getElementById('btn-container-buy');
                const view = document.getElementById('btn-view-course');
                
                if(owned) { buy.classList.add('hidden'); view.classList.remove('hidden'); }
                else { buy.classList.remove('hidden'); view.classList.add('hidden'); }

                const list = document.getElementById('preview-list');
                
                if(owned) {
                    list.innerHTML = c.questions.map((q, i) => `
                        <div onclick="app.openAnswers()" class="bg-white border border-slate-100 rounded-2xl p-5 shadow-sm mb-3 flex items-center justify-between cursor-pointer hover:border-brand-blue transition group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-green-50 text-green-600 font-bold flex items-center justify-center text-xs group-hover:bg-green-100"><i class="fa-solid fa-check"></i></div>
                                <span class="font-bold text-brand-dark text-sm">Question ${i + 1}</span>
                            </div>
                            <div class="flex items-center gap-2"><span class="text-[10px] text-brand-sub font-medium uppercase">View</span><i class="fa-solid fa-chevron-right text-slate-300 text-xs group-hover:text-brand-blue"></i></div>
                        </div>
                    `).join('');
                } else {
                    let html = '';
                    if(c.questions.length > 0) {
                        html += `
                        <div class="bg-white border border-slate-100 rounded-3xl overflow-hidden shadow-card mb-4 relative">
                            <div class="absolute top-0 right-0 bg-brand-blue text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl z-10">FREE PREVIEW</div>
                            <div class="p-6">
                                <h4 class="font-serif font-bold text-brand-dark mb-4 text-lg leading-snug">${c.questions[0].q}</h4>
                                <div class="mt-4 pt-4 border-t border-slate-50 text-center"><span class="text-xs text-brand-blue font-bold cursor-pointer hover:underline">Read full answer</span></div>
                            </div>
                        </div>`;
                        
                        for(let i=1; i<c.questions.length; i++) {
                            html += `
                            <div class="relative bg-white border border-slate-100 rounded-2xl p-5 overflow-hidden mb-3">
                                <div class="filter blur-[4px] opacity-40 select-none">
                                    <div class="flex items-center gap-3 mb-2"><div class="w-6 h-6 rounded-full bg-slate-200 text-xs font-bold flex items-center justify-center text-slate-500">${i+1}</div><div class="h-4 w-48 bg-slate-200 rounded"></div></div>
                                    <div class="space-y-2 pl-9"><div class="h-2 w-full bg-slate-100 rounded"></div><div class="h-2 w-5/6 bg-slate-100 rounded"></div></div>
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center bg-white/30 backdrop-blur-[1px]"><div class="w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center text-slate-400"><i class="fa-solid fa-lock text-xs"></i></div></div>
                            </div>`;
                        }
                    }
                    list.innerHTML = html;
                }
                this.navigateTo('course-detail');
            },

            openAnswers: function() {
                const c = COURSES_DB.find(x => x.id === this.state.currentCourseId);
                document.getElementById('ans-code').innerText = c.code;
                
                const wmLayer = document.getElementById('watermark-layer');
                wmLayer.innerHTML = '';
                const wmText = this.state.profile ? this.state.profile.full_name : this.state.user.email;
                for(let i=0; i<8; i++) wmLayer.innerHTML += `<div class="watermark-line">${wmText.toUpperCase()}</div>`;

                const container = document.getElementById('full-answers-container');
                container.innerHTML = c.questions.map((q, idx) => {
                    const steps = q.a.split('### ').filter(Boolean);
                    const stepsHtml = steps.map(s => {
                        const [title, ...body] = s.split('\n');
                        return `
                        <div class="relative pl-6 mb-6 group last-step">
                            <div class="step-line"></div>
                            <div class="absolute left-0 top-1 w-2 h-2 rounded-full bg-brand-pink ring-4 ring-white"></div>
                            <div class="text-[10px] font-bold text-brand-pink uppercase tracking-widest mb-1">${title}</div>
                            <div class="text-brand-text leading-relaxed font-serif text-base">${body.join('<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div>
                        </div>`;
                    }).join('');
                    return `<div class="mb-16"><div class="font-serif font-bold text-xl text-brand-dark mb-6 leading-snug">Q${idx+1}: ${q.q}</div>${stepsHtml}</div>`;
                }).join('');

                this.navigateTo('answers');
            },

            renderLibrary: function() {
                const list = document.getElementById('purchases-list');
                const myCourses = COURSES_DB.filter(c => this.state.purchasedIds.includes(c.id));
                if(myCourses.length === 0) { list.innerHTML = `<div class="text-center py-10 text-brand-sub">No courses unlocked yet.</div>`; return; }
                list.innerHTML = myCourses.map(c => `
                    <div onclick="app.openCourse('${c.id}')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer">
                        <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fa-solid fa-check"></i></div>
                        <div class="flex-grow"><h3 class="font-bold text-brand-dark">${c.code}</h3><p class="text-xs text-brand-sub">${c.title}</p></div><i class="fa-solid fa-arrow-right text-slate-300"></i>
                    </div>`).join('');
            },
            
            renderProfile: function() {
                if(this.state.profile) {
                    const name = this.state.profile.full_name || 'Student';
                    document.getElementById('profile-initial').innerText = name.charAt(0);
                    document.getElementById('profile-name').innerText = name;
                    document.getElementById('profile-details').innerText = `${this.state.profile.faculty} â€¢ ${this.state.profile.level}`;
                }
            },

            showToast: function(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('-translate-y-24');
                setTimeout(() => t.classList.add('-translate-y-24'), 3000);
            }
        };

        window.onload = function() { app.init(); }
    </script>
</body>
</html>
